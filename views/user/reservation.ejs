<%- include('./partials/header') %>

<!--============= PAGE-COVER =============-->
<section class="page-cover" id="reservation-cover">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1 class="page-title">Book Reservation</h1>
        <ul class="breadcrumb justify-content-center">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="active breadcrumb-item">Reservation</li>
        </ul>
      </div>
      <!-- end columns -->
    </div>
    <!-- end row -->
  </div>
  <!-- end container -->
</section>
<!-- end page-cover -->

<!--=============INNERPAGE-WRAPPER ===========-->
<section id="reservation-page" class="innerpage-wrapper">
  <div id="reservation" class="search-bar">
    <div class="container">
      <div class="row">
        <div class="col-12 col-md-12 col-lg-8 col-xl-8">
          <div class="space-right">
            <div class="innerpage-heading">
              <h1>Reservation</h1>
            </div>
            <!-- end innerpage-heading -->

            <form id="bookingForm">
              <div class="row">
                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="form-group">
                    <span><i class="fa fa-angle-down"></i></span>
                    <select class="form-control roomType">
                      <option selected>Room Type</option>
                      <option value="deluxe">Deluxe</option>
                      <option value="twin">Twin</option>
                    </select>
                  </div>
                </div>
                <!-- end columns -->

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="form-group">
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Name"
                      required
                    />
                    <span><i class="fa fa-user"></i></span>
                  </div>
                </div>
                <!-- end columns -->

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="form-group">
                    <input
                      type="email"
                      class="form-control"
                      placeholder="Email"
                      required
                    />
                    <span><i class="fa fa-envelope"></i></span>
                  </div>
                </div>
                <!-- end columns -->

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="form-group">
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Phone Number"
                      required
                    />
                    <span><i class="fa fa-phone"></i></span>
                  </div>
                </div>
                <!-- end columns -->

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="form-group">
                    <input
                      type="date"
                      class="form-control dpd1"
                      placeholder="Arrival Date"
                      required
                    />
                  </div>
                </div>

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="form-group">
                    <input
                      type="date"
                      class="form-control dpd2"
                      placeholder="Departure Date"
                      required
                    />
                  </div>
                </div>

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <label for="adults">Adults</label>
                  <div class="form-group">
                    <span><i class="fa fa-angle-down"></i></span>
                    <select class="form-control" name="adults" required>
                      <option selected>0</option>
                      <option>1</option>
                      <option>2</option>
                      <option>3</option>
                    </select>
                  </div>
                </div>
                <!-- end columns -->

                <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <label for="children">Children</label>
                  <div class="form-group">
                    <span><i class="fa fa-angle-down"></i></span>
                    <select class="form-control" name="children" required>
                      <!-- <option selected>Children</option> -->
                      <option selected>0</option>
                      <option>1</option>
                      <option>2</option>
                      <option>3</option>
                    </select>
                  </div>
                </div>
                <!-- end columns -->

                <div class="d-flex flex-wrap align-items-center mb-3 justify-content-between w-100">
                  <div class="m-3 fw-bold">Other Services:</div>
                  <div class="m-3">

                    <div
                      class="form-check form-check-inline me-3 align-items-center"
                    >
                      <input
                        type="checkbox"
                        class="form-check-input service-checkbox"
                        data-price="20"
                        id="campfire"
                        style="cursor: pointer;"
                      />
                      <label class="form-check-label ms-2" for="campfire"
                        >Campfire (₹20)</label
                      >
                    </div>
  
                    <div
                      class="form-check form-check-inline me-3 align-items-center"
                    >
                      <input
                        type="checkbox"
                        class="form-check-input service-checkbox"
                        data-price="30"
                        id="pool"
                        style="cursor: pointer;"
                      />
                      <label class="form-check-label ms-2" for="pool"
                        >Pool (₹30)</label
                      >
                    </div>
  
                    <div class="form-check form-check-inline align-items-center">
                      <input
                        type="checkbox"
                        class="form-check-input service-checkbox"
                        data-price="10"
                        id="kitchen"                      
                        style="cursor: pointer;"
                      />
                      <label class="form-check-label ms-2" for="kitchen"
                        >Kitchen Access (₹10)</label
                      >
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-group">
                    <label>Total Amount: </label>
                    <input
                      type="text"
                      id="totalAmount"
                      class="form-control"
                      readonly
                    />
                  </div>
                </div>

                <div class="col-12 col-md-12 col-lg-12 col-xl-12">
                  <button type="submit" class="btn btn-yellow" id="submit">
                    Reserve Now
                  </button>
                </div>

                <!-- end columns -->
              </div>
              <!-- end row -->
            </form>
          </div>
          <!-- end space-right -->
        </div>
        <!-- end columns -->

        <div class="col-12 col-md-12 col-lg-4 col-xl-4 side-bar">
          <div class="selected-room-block">
            <div class="selected-room-img">
              <img
                src="images/selected-room.jpg"
                class="img-fluid"
                alt="selected-room"
              />
            </div>
            <!-- end selected-room-img -->

            <div class="selected-room-detail">
              <h2>Single Room</h2>

              <p>
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed
                diam nonummy nibh euismod tincidunt .
              </p>

              <p class="selected-room-price">From <span>₹89</span> / Night</p>
            </div>
            <!-- end selected-room-detail -->
          </div>
          <!-- end selected-room-block -->
        </div>
        <!-- end columns -->
      </div>
      <!-- end row -->
    </div>
    <!-- end container -->
  </div>
  <!-- end reservation -->

  <div id="reservation-details">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12 col-md-12 col-lg-6 col-xl-6 reservation-info">
          <div class="reserve-position center">
            <div class="innerpage-heading">
              <h1 style="color: white;">How to make reservation</h1>
            </div>
            <!-- end innerpage-heading -->

            <p>
              Booking your stay with us is quick and easy. Follow these simple
              steps to secure your reservation at Kosher Livings.
            </p>
            <p>
              1. Select your preferred check-in and check-out dates. <br />
              2. Choose the room type that suits your needs. <br />
              3. Enter your contact details and complete the payment process.
              <br />
            </p>
            <p>
              Once your reservation is confirmed, you will receive a
              confirmation email with all the necessary details. If you need
              assistance, our support team is here to help.
            </p>
            <span class="hotel-name" style="color: whitesmoke;">Kosher Livings Holidays</span>
          </div>
          <!-- end reserve-position -->
        </div>
        <!-- end columns -->

        <div class="col-12 col-md-12 col-lg-6 col-xl-6 reservation-support">
          <div class="center">
            <div class="innerpage-heading">
              <h1>Reservation Support</h1>
            </div>
            <!-- end innerpage-heading -->

            <div class="support-list">
              <div class="icon">
                <span><i class="fa fa-envelope"></i></span>
              </div>
              <div class="text">
                <p>
                  If you are on the go and still want to ask a question, simply
                  drop us an e-mail.
                </p>
                <p class="bold">kosherlivingsholiday@gmail.com</p>
              </div>
              <!-- end text -->
            </div>
            <!-- end support-list -->

            <div class="support-list">
              <div class="icon">
                <span><i class="fa fa-phone"></i></span>
              </div>
              <div class="text phone">
                <p>
                  If you are on the go and still want to ask a question, simply
                  drop us an e-mail.
                </p>
                <p class="bold">
                  +91 81139 15515 <br />
                  +91 89435 15515
                </p>
              </div>
              <!-- end text -->
            </div>
            <!-- end support-list -->

            <div class="support-list">
              <div class="icon">
                <span><i class="fa fa-map-marker"></i></span>
              </div>
              <div class="text">
                <p class="bold">Bypass Link Road, Kalpetta</p>
                <p>Wayanad, Kerala</p>
                <p>673121</p>
              </div>
              <!-- end text -->
            </div>
            <!-- end support-list -->
          </div>
          <!-- end center -->
        </div>
        <!-- end columns -->
      </div>
      <!-- end row -->
    </div>
    <!-- end container -->
  </div>
  <!-- end reservation-details -->
</section>
<!-- end innerpage-wrapper -->
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const arrival = urlParams.get("arrival");
  const departure = urlParams.get("departure");
  const adults = urlParams.get("adults");
  const children = urlParams.get("children");
  const roomData = urlParams.get("room");
  const room = roomData ? JSON.parse(decodeURIComponent(roomData)) : {};

  if (adults) document.querySelector('select[name="adults"]').value = adults;
  if (children)
    document.querySelector('select[name="children"]').value = children;

  function setValueAndDisable(selector, value) {
    const element = document.querySelector(selector);
    if (value) {
      element.value = value;
      element.setAttribute("disabled", "disabled");
    }
  }

  setValueAndDisable(".dpd1", arrival);
  setValueAndDisable(".dpd2", departure);

  if (room.roomType) {
    const roomTypeSelect = document.querySelector(".roomType");
    [...roomTypeSelect.options].forEach((option) => {
      if (option.value.toLowerCase() === room.roomType.toLowerCase()) {
        roomTypeSelect.value = option.value;
        roomTypeSelect.setAttribute("disabled", "disabled");
      }
    });
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkboxes = document.querySelectorAll(".service-checkbox");
    const totalAmountField = document.getElementById("totalAmount");
    const bookingForm = document.getElementById("bookingForm");
    const submitBtn = document.getElementById("submit");

    let total = room.price ? parseFloat(room.price) : 0;

    function updateTotal() {
      let servicesTotal = 0;
      checkboxes.forEach((checkbox) => {
        if (checkbox.checked) {
          servicesTotal += parseFloat(checkbox.getAttribute("data-price"));
        }
      });

      totalAmountField.value = `₹ ${total + servicesTotal}`;
    }

    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", updateTotal);
    });

    updateTotal();

    bookingForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const selectedServices = Array.from(checkboxes)
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => ({
          name: checkbox.id,
          price: parseFloat(checkbox.getAttribute("data-price")),
        }));
      console.log(selectedServices);

      const data = {
        roomType: document.querySelector(".roomType").value,
        name: document.querySelector('input[placeholder="Name"]').value,
        email: document.querySelector('input[placeholder="Email"]').value,
        contact: document.querySelector('input[placeholder="Phone Number"]')
          .value,
        arrival: document.querySelector(".dpd1").value,
        departure: document.querySelector(".dpd2").value,
        adults: parseInt(
          document.querySelector('select[name="adults"]').value,
          10
        ),
        children: parseInt(
          document.querySelector('select[name="children"]').value,
          10
        ),
        services: selectedServices, // Include selected services
        amount:
          total +
          selectedServices.reduce((sum, service) => sum + service.price, 0),
        bookingType: "online",
      };

      // Ensure all required fields are filled
      for (const key in data) {
        if (data[key] === "" || data[key] == null) {
          await Swal.fire({
            icon: "warning",
            title: "Missing Information",
            text: `Please fill out the ${key} field.`,
          });
          return;
        }
      }

      submitBtn.disabled = true;
      submitBtn.innerText = "Processing...";

      try {
        // Create Razorpay order
        const orderResponse = await fetch("/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: data.amount }),
        });

        const { id: order_id, amount, currency } = await orderResponse.json();

        const options = {
          key: "rzp_test_1ziG9HjgAv6f6j",
          amount: amount,
          currency: currency,
          name: "Kosher Livings",
          description: "Room Reservation",
          order_id: order_id,
          handler: async function (payment) {
            await Swal.fire({
              icon: "success",
              title: "Payment Successful!",
              text: "Your booking is being processed.",
            });

            // Add Razorpay payment ID
            data.razorpay_payment_id = payment.razorpay_payment_id;

            // Send complete booking data
            const saveResponse = await fetch("/add-booking", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (saveResponse.ok) {
              await Swal.fire({
                icon: "success",
                title: "Booking Confirmed!",
                text: "Your reservation is successful.",
              });
              window.location.href = "/";
            } else {
              await Swal.fire({
                icon: "error",
                title: "Error",
                text: "There was an issue saving your booking. Please contact support.",
              });
            }
          },
          prefill: {
            name: data.name,
            email: data.email,
            contact: data.contact,
          },
          theme: {
            color: "#F37254",
          },
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        console.error("Error:", error);
        await Swal.fire({
          icon: "error",
          title: "Payment Failed",
          text: "Something went wrong. Please try again!",
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "Reserve Now";
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sidebar = document.querySelector(".side-bar");
    const roomImage =
      room.image && room.image.length > 0
        ? room.image[0]
        : "images/default.jpg";
    const roomType = room.roomType === "deluxe" ? "Deluxe Room" : "Twin Room";
    const roomPrice = room.price ? `₹${room.price}` : "Price not available";
    const roomDescription = room.description || "No description available.";

    // Updating the sidebar with dynamic content
    sidebar.innerHTML = `
    <div class="selected-room-block">
      <div class="selected-room-img">
        <img src="${roomImage}" class="img-fluid" alt="${roomType}" />
      </div>
      <div class="selected-room-detail">
        <h2>${roomType}</h2>
        <p>${roomDescription}</p>
        <p class="selected-room-price">From <span>${roomPrice}</span> / Night</p>
      </div>
    </div>
  `;
  });
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<%- include('./partials/footer') %>
